import { createSignal, Show, onMount, For } from 'solid-js';
import { useSearchParams, useNavigate } from '@solidjs/router';
import { H1, H2, H3, Body } from '../components/ui/Typography';
import Card from '../components/ui/Card';
import Button from '../components/ui/Button';
import Badge from '../components/ui/Badge';
import ContentContainer from '../components/layout/ContentContainer';
import { BarChart3, FileText, Brain, CheckCircle, XCircle, Download, ArrowLeft } from 'lucide-solid';
import { analyzeCodeWithReport, type AnalisisResponse } from '../api/analyzer';

/**
 * Results page - Display comprehensive complexity analysis results
 */
export default function Results() {
  const [searchParams] = useSearchParams();
  const navigate = useNavigate();

  const [analysisResult, setAnalysisResult] = createSignal<AnalisisResponse | null>(null);
  const [isLoading, setIsLoading] = createSignal(true);
  const [error, setError] = createSignal<string | null>(null);

  onMount(async () => {
    const pseudocodigo = searchParams.pseudocodigo;

    if (!pseudocodigo) {
      setError('No se proporcionó pseudocódigo para analizar');
      setIsLoading(false);
      return;
    }

    try {
      setIsLoading(true);
      const result = await analyzeCodeWithReport({
        entrada: pseudocodigo,
        tipo_entrada: 'auto',
        auto_corregir: true
      });

      setAnalysisResult(result);
    } catch (err) {
      console.error('Error analyzing code:', err);
      setError(err instanceof Error ? err.message : 'Error desconocido al analizar el código');
    } finally {
      setIsLoading(false);
    }
  });

  const downloadMarkdown = () => {
    const result = analysisResult();
    if (!result?.reporte_markdown) return;

    const blob = new Blob([result.reporte_markdown], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'reporte-analisis-complejidad.md';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const getComplexityBadge = (complexity: string | undefined): 'success' | 'warning' | 'danger' => {
    if (!complexity) return 'info';
    const lower = complexity.toLowerCase();
    if (lower.includes('o(1)') || lower.includes('θ(1)')) return 'success';
    if (lower.includes('o(n)') || lower.includes('θ(n)') || lower.includes('o(log')) return 'warning');
    return 'danger';
  };

  return (
    <ContentContainer>
      <Show
        when={!isLoading()}
        fallback={
          <div class="flex flex-col items-center justify-center min-h-[60vh]">
            <BarChart3 class="w-16 h-16 text-purple-400 animate-pulse mb-4" />
            <H2>Analizando pseudocódigo...</H2>
            <Body class="text-gray-600 mt-2">Esto puede tomar algunos segundos</Body>
          </div>
        }
      >
        <Show
          when={!error() && analysisResult()}
          fallback={
            <div class="flex flex-col items-center justify-center min-h-[60vh]">
              <XCircle class="w-16 h-16 text-red-400 mb-4" />
              <H2>Error en el análisis</H2>
              <Body class="text-gray-600 mt-2 mb-6">{error()}</Body>
              <Button variant="primary" onClick={() => navigate('/validador')}>
                <ArrowLeft class="w-5 h-5 mr-2" />
                Volver al validador
              </Button>
            </div>
          }
        >
          {(result) => (
            <div class="space-y-6 animate-fade-in-up">
              {/* Header */}
              <div class="flex items-center justify-between">
                <div>
                  <H1 class="mb-2">Resultados del Análisis</H1>
                  <div class="flex items-center gap-3">
                    <Show
                      when={result.exito}
                      fallback={
                        <>
                          <XCircle class="w-5 h-5 text-red-500" />
                          <Body class="text-red-600">Análisis completado con errores</Body>
                        </>
                      }
                    >
                      <CheckCircle class="w-5 h-5 text-green-500" />
                      <Body class="text-green-600">Análisis completado exitosamente</Body>
                    </Show>
                  </div>
                </div>
                <div class="flex gap-3">
                  <Button variant="ghost" onClick={() => navigate('/validador')}>
                    <ArrowLeft class="w-5 h-5 mr-2" />
                    Volver
                  </Button>
                  <Show when={result.reporte_markdown}>
                    <Button variant="blue" onClick={downloadMarkdown}>
                      <Download class="w-5 h-5 mr-2" />
                      Descargar Reporte
                    </Button>
                  </Show>
                </div>
              </div>

              {/* Resumen Ejecutivo */}
              <Card title="Resumen Ejecutivo">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Body class="text-sm text-gray-600 mb-1">Tipo de Algoritmo</Body>
                    <Body class="font-bold text-lg">{result.validacion?.tipo_algoritmo || 'No determinado'}</Body>
                  </div>
                  <div>
                    <Body class="text-sm text-gray-600 mb-1">Fase Actual</Body>
                    <Body class="font-bold text-lg capitalize">{result.fase_actual?.replace(/_/g, ' ') || 'Completado'}</Body>
                  </div>
                </div>

                <Show when={result.complejidades?.complejidades}>
                  <div class="mt-6">
                    <H3 class="mb-4">Complejidades Computacionales</H3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div class="p-4 rounded-lg bg-green-50 border-2 border-green-200">
                        <Body class="text-sm text-green-700 mb-2">Mejor Caso (Ω)</Body>
                        <Badge variant={getComplexityBadge(result.complejidades!.complejidades!.mejor_caso)} class="text-lg px-4 py-2">
                          {result.complejidades!.complejidades!.mejor_caso || 'N/A'}
                        </Badge>
                      </div>
                      <div class="p-4 rounded-lg bg-yellow-50 border-2 border-yellow-200">
                        <Body class="text-sm text-yellow-700 mb-2">Caso Promedio (Θ)</Body>
                        <Badge variant={getComplexityBadge(result.complejidades!.complejidades!.caso_promedio)} class="text-lg px-4 py-2">
                          {result.complejidades!.complejidades!.caso_promedio || 'N/A'}
                        </Badge>
                      </div>
                      <div class="p-4 rounded-lg bg-red-50 border-2 border-red-200">
                        <Body class="text-sm text-red-700 mb-2">Peor Caso (O)</Body>
                        <Badge variant={getComplexityBadge(result.complejidades!.complejidades!.peor_caso)} class="text-lg px-4 py-2">
                          {result.complejidades!.complejidades!.peor_caso || 'N/A'}
                        </Badge>
                      </div>
                    </div>
                  </div>
                </Show>
              </Card>

              {/* Clasificación ML */}
              <Show when={result.clasificacion}>
                <Card title="Clasificación de Algoritmo (Machine Learning)">
                  <div class="flex items-center gap-4 mb-4">
                    <Brain class="w-12 h-12 text-purple-500" />
                    <div class="flex-1">
                      <Body class="text-sm text-gray-600">Categoría Detectada</Body>
                      <H2 class="capitalize">{result.clasificacion!.categoria_principal.replace(/_/g, ' ')}</H2>
                      <Body class="text-sm text-gray-600 mt-1">
                        Confianza: {(result.clasificacion!.confianza * 100).toFixed(1)}%
                      </Body>
                    </div>
                  </div>

                  <Show when={result.clasificacion!.top_predicciones?.length > 0}>
                    <div class="mt-4">
                      <Body class="text-sm text-gray-700 mb-3 font-semibold">Otras Posibilidades:</Body>
                      <div class="space-y-2">
                        <For each={result.clasificacion!.top_predicciones.slice(0, 3)}>
                          {(pred, index) => (
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                              <Body class="capitalize">#{index() + 1} {pred.categoria.replace(/_/g, ' ')}</Body>
                              <Badge variant="info">{(pred.probabilidad * 100).toFixed(1)}%</Badge>
                            </div>
                          )}
                        </For>
                      </div>
                    </div>
                  </Show>
                </Card>
              </Show>

              {/* Pseudocódigo Validado */}
              <Card title="Pseudocódigo Validado">
                <pre class="bg-gray-50 p-4 rounded-lg overflow-x-auto font-mono text-sm border border-gray-200">
                  {result.pseudocodigo_validado || result.pseudocodigo_original || 'No disponible'}
                </pre>
              </Card>

              {/* Flowchart */}
              <Show when={result.flowchart}>
                <Card title="Diagrama de Flujo">
                  <div class="bg-gray-50 p-4 rounded-lg overflow-x-auto">
                    <pre class="font-mono text-sm whitespace-pre-wrap">{result.flowchart}</pre>
                  </div>
                </Card>
              </Show>

              {/* Reporte Completo en Markdown */}
              <Show when={result.reporte_markdown}>
                <Card title="Reporte Completo">
                  <div class="prose prose-sm max-w-none">
                    <div class="bg-white p-6 rounded-lg border border-gray-200">
                      <pre class="whitespace-pre-wrap font-sans text-sm leading-relaxed">{result.reporte_markdown}</pre>
                    </div>
                  </div>
                  <div class="mt-4 flex justify-end">
                    <Button variant="blue" onClick={downloadMarkdown}>
                      <Download class="w-5 h-5 mr-2" />
                      Descargar como Markdown
                    </Button>
                  </div>
                </Card>
              </Show>

              {/* Errores */}
              <Show when={result.errores && result.errores.length > 0}>
                <Card title="Errores Encontrados">
                  <div class="space-y-2">
                    <For each={result.errores}>
                      {(error, index) => (
                        <div class="flex items-start gap-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                          <div class="flex-shrink-0 w-6 h-6 bg-red-200 rounded-full flex items-center justify-center">
                            <span class="text-xs font-bold text-red-700">{index() + 1}</span>
                          </div>
                          <Body class="text-sm text-red-800">{error}</Body>
                        </div>
                      )}
                    </For>
                  </div>
                </Card>
              </Show>
            </div>
          )}
        </Show>
      </Show>
    </ContentContainer>
  );
}
